---
title: "Data analysis skeleton: Update to reflect your team's analyses!"
output: html_document
---

# Load necessary packages
```{r}
#install.packages('pacman', repos = "http://cran.us.r-project.org")
pacman::p_load(tidyverse, broom, lubridate, performance, see, qqplotr, gvlma)
```

# Load cleaned data files
## Data type 1: 
```{r, eval = FALSE}
mammals <- read_csv('./clean_data/mammals_clean.csv') %>% 
  mutate(year = year(collectDate),
         month = month(collectDate),
         date = make_date(year, month),
         tagID = factor(tagID),
         taxonID = factor(taxonID)) %>%
  select(siteID, year, month, date, plotID, taxonID, tagID)
```
## Summarize mammals to monthly counts
```{r}
mammals_monthly <- mammals %>%
  group_by(siteID, year, month, taxonID) %>%
  summarize(mammal_count = n()) %>% 
  mutate(date = make_date(year, month)) %>%
  select(siteID, year, month, date, taxonID, mammal_count) %>% 
  drop_na()%>%
  filter(taxonID=="PELE")
```


## Data type 2:
```{r, eval = FALSE}
temp <- read_csv('./clean_data/temp_clean.csv')

glimpse(temp)
```

## Summarize temp to monthly mean
```{r}
temp_monthly <- temp %>%
  group_by(siteID, year, month) %>%
  summarize(monthlyTemp = mean(tempSingleMean)) %>%
  mutate(date = make_date(year, month)) %>%
  select(siteID, year, month, date, monthlyTemp)
```

##Data type 3
```{r, eval = FALSE}
ticks <- read_csv('./clean_data/ticks_clean.csv') %>% 
  mutate(year = year(collectDate),
         month = month(collectDate),
         date = make_date(year, month)) %>%
  select(siteID, year, month, date, plotID, adultCount:larvaCount)
```

## Combine data files based on shared criteria
Type out some details of what the column names are that your data objects have in common. Note that for R to combine them, the column names must be **exactly** the same (e.g., spelling, capitalization, etc.)
```{r, eval = FALSE}
data <- full_join(mammals_monthly, ticks) %>%
  full_join(., temp_monthly)

print(data)
```

```{r}
monthly <- data %>%
  group_by(siteID,date) %>%
  summarize(monthlyTemp = mean(monthlyTemp),
            all_mammals = sum(mammal_count),
            sum_adult=sum(adultCount),
            sum_nymph= sum(nymphCount),
            sum_larva=sum(larvaCount))
```


# Statistical analysis:
* If your independent variable is categorical (e.g., siteID) and your dependent variable is continuous (numeric values), you should perform an ANOVA.  
For ANOVA, the R syntax is: **aov(dependent_variable_name ~ independent_variable_name, data = data_object_name)**
```{r}
adults_per_site <- aov(sum_adult ~ siteID,  data= monthly )
```

* If your independent variable and your dependent variable are both continuous (numeric values), you should perform a linear regression.  
For linear regression, the R syntax is: **lm(dependent_variable_name ~ independent_variable_name, data = data_object_name)**
```{r}

```


Note that you should use a different "model_name" for each statistical test you are conducting.

## Summary/descriptive statistics
Often, we report summary statistics like the mean, a measure of variance (standard deviation, standard error, 95% confidence intervals) and the sample size. 

We can do this easily through the use of `dplyr()` commands. In this example, we can calculate average annual values per site using:
```{r}
summary <- monthly %>% 
  mutate(year = year(date)) %>% 
  group_by(siteID, year) %>% 
  summarize(n = n(),  # Sample size
            mean_var1 = mean(monthlyTemp), sd_var1 = sd(Var1), se_var1 = sd_var1/sqrt(n), # Mean, sd, se for var1
            mean_var2 = mean(all_mammals), sd_var2 = sd(Var2), se_var2 = sd_var2/sqrt(n)) # Mean, sd, se for var1

glimpse(summary)
```

To simplify reporting, we can also ask R to round all of these calculated values to a specific number of decimal places:
```{r}
summary <- as_tibble(summary) %>% 
  mutate_at(vars(mean_var1:se_var2), funs(round(.,2))) # Round each of our calculated columns to 2 decimals

print(summary)
```

## ANOVA
Write a brief statement about what you're comparing, ecologically, with each planned analysis.

First, let's make a quick plot of our site-level response variable; after we run our ANOVA we can visually compare this graph our statistical test results:
```{r}
ggplot(data = monthly, aes(x = siteID, # name the variable that goes on the x-axis
                                    y = sum_adult,  # name the variable that goes on the y-axis
                                    fill = siteID)) + # name the variable to differentiate colors
  geom_boxplot() +  # Graph these variables using boxplots
  theme_minimal()
```

Now, we're ready to define our ANOVA model:
```{r}
adults_per_site <- aov(sum_adult ~ siteID,  data= monthly )
```

Next, we can use this quick command to check the ANOVA model assumptions:
```{r, warning=F}
# Check for homogeneity of variance: 
leveneTest(dependent_variable_name ~ independent_variable_name, data = data_object_name)
# If the p-value of Levene's test is greater than 0.05, we have not violated the assumption of homogeneity of variance

# Check for normality of residuals:
## 1) Extract the model residuals
aov_residuals <- residuals(object = model_name)

## 2) Run Shapiro-Wilk test
shapiro.test(x = aov_residuals )

# Visualize model checks as graphs
check_model(model_name)
```

*(If our data violate the homogeneity of variance assumption, we can instead do a Welch one-way test using the `oneway.test()` function below)*
```{r}
oneway.test(dependent_variable_name ~ independent_variable_name, data = data_object_name)

pairwise.t.test(data_object_name$dependent_variable_name,
                data_object_name$independent_variable_name,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

If our model assumptions seem to be satisfied, we can look at the ANOVA output! 
```{r}
summary(adults_per_site)
```
If the model p-value is smaller than 0.05 (our standard alpha), we reject the null hypothesis and conclude that there is a significant difference in our dependent variable between *at least two* sites.

But which site(s) are different? We'll use a post-hoc Tukey test to find out!
```{r}
tukey <- tidy(TukeyHSD(adults_per_site))
print(tukey)
```
Note that the "estimate" column tells you how different the mean values of each pair of sites is.

If you have a *lot* of contrasts, you can run the command below to only show the statistically significant (p <0.05) contrasts:
```{r}
tukey %>% 
  filter(adj.p.value < 0.05)
```

If you have a *lot* of contrasts, you can run the command below to only show the statistically significant (p <0.05) contrasts:
```{r}
sig <- tukey %>% 
  filter(adj.p.value < 0.05)

print(sig)
```

## Correlation &Linear regression
Write a brief statement about what you're comparing, ecologically, with each planned analysis.
We are comparing our monthly temperature data to tick populations across different sites. We are also comparing the small mammal populations with tick populations at the sites. 
First, let's make a quick plot to see what the data look like
```{r}
ggplot(data = monthly, aes(x = monthlyTemp, # name the variable that goes on the x-axis
                                    y = sum_adult,  # name the variable that goes on the y-axis
                                    col = siteID)) + # name the variable to differentiate colors
  geom_point(pch = 16) +  # Graph these variables as a scatterplot
  theme_minimal()
```

We can calculate a correlation coefficient to quantify the strength and direction of association between the two variables.

The types of correlation you can use are:  

* Pearson: Parametric correlation (requires data be normally distributed) for continuous data   

* Spearman: Non-parametric (e.g., if your data are not normally distributed) correlation can also take ordinal data

```{r}
cor_alpha <- cor.test(monthly$sum_adult, 
                      monthly$monthlyTemp, 
                      method = "pearson") # can also use method = "spearman"

tidy(cor_alpha)
```

Now, let's set up and run a linear model to conduct a linear regression.
```{r}
tempVticks <- lm(monthlyTemp ~ sum_adult, data = monthly)
```

Next, we can use a few quick commands to check the linear regression model assumptions:
```{r, warning=F}
#check_model(model_name2)
gvlma(tempVticks)
```

If our model assumptions seem to be satisfied, we can look at the ANOVA output! 
```{r}
summary(tempVticks)
```

And make a quick plot with the calculated best fit lines for each site. Remember that ecological data reporting convention is to **omit** the trend line for non-significant relationships.
```{r, message=F}
ggplot(data = monthly, aes(x = monthlyTemp, # name the variable that goes on the x-axis
                                    y = sum_adult,  # name the variable that goes on the y-axis
                                    col = siteID)) + # name the variable to differentiate colors
  geom_point(pch = 16) +  # Graph these variables as a scatterplot
  #geom_smooth(method = 'lm', aes(group=1), col = 'black', lty = 2) +  # lty=1 for solid line
  #geom_abline(intercept = 6.81098, slope = -0.08871) +  # Alternate method than geom_smooth to specify line slope & intercept
  theme_minimal()
```